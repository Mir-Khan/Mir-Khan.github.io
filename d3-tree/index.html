<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D3 Tree Map</title>
    <link href="../styles.css" rel="stylesheet">
    <script src="https://kit.fontawesome.com/63ada23c4f.js" crossorigin="anonymous"></script>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="https://d3js.org/d3-hierarchy.v1.min.js"></script>
    <script src="https://d3js.org/d3-format.v1.min.js"></script>
</head>

<body class="tree-body">
    <div id="description" class="tree-description">
        <p>This tree map was made using <a href="https://d3js.org/">D3</a> and the data provided by <a
                href="https://www.freecodecamp.org/">Freecodecamp</a></p>
    </div>
    <div id="data" class="tree-container">
        <div id="title" class="tree-title"></div>
    </div>
    <script>
        // data sources
        const KICKSTARTER = "https://cdn.freecodecamp.org/testable-projects-fcc/data/tree_map/kickstarter-funding-data.json";
        const MOVIE_SALES = "https://cdn.freecodecamp.org/testable-projects-fcc/data/tree_map/movie-data.json";
        const VG_SALES = "https://cdn.freecodecamp.org/testable-projects-fcc/data/tree_map/video-game-sales-data.json";

        // dimensions of svg
        const w = 800;
        const h = 550;

        // tooltip creation
        let tooltip = d3.select("body").append("div")
            .attr("class", "tree-tip")
            .attr("id", "tooltip")
            .style("opacity", 0);

        Promise.all([d3.json(KICKSTARTER), d3.json(MOVIE_SALES), d3.json(VG_SALES)]).then(function (files) {
            var kick = files[0];
            var movie = files[1];
            var vg = files[2];

            treeMap(vg, "Video Games", VG_SALES);

            // the function that will create the treemap based on the data provided
            function treeMap(source, type, url) {
                // clear the space for the new elements to be appended
                removeElements();

                // svg for the treemap creation
                const svgTree = d3.select("#data").append("svg")
                    .attr("class", "treeClass")
                    .attr("height", h)
                    .attr("width", w)
                    .attr("id", "treemap");

                // title creation
                d3.select("#title")
                    .append("text")
                    .html("<h1>" + type + " Tree Map" + "</h1>" + "<br/>" + "<p>" + "The selected treemap was made using this " + "<a href='" + url + "'>" + "data" + "</a>" + "<br/>" + "<p>")

                // switching data source
                const buttonBox = d3.select("#title")
                    .append("svg")
                    .attr("width", 300)
                    .attr("height", 50)
                    .selectAll("g")
                    .data(["Video Games", "Movies", "Kickstarter"])
                    .join("g")
                    .attr("transform", (d, i) => "translate(" + i * 100 + "," + 25 + ")");

                buttonBox.append("rect")
                    .attr("id", (d) => d)
                    .attr("width", 75)
                    .attr("height", 25)
                    .attr("x", 0)
                    .attr("y", 0)
                    .attr("rx", 5)
                    .attr("ry", 8)
                    .attr("cursor", "pointer")
                    .attr("class", "tree-buttons")
                    .on("click", (d) => {
                        let selectedUrl = d === "Video Games" ? VG_SALES : d === "Movies" ? MOVIE_SALES : KICKSTARTER;
                        let selectedData = d === "Video Games" ? vg : d === "Movies" ? movie : kick;
                        treeMap(selectedData, d, selectedUrl);
                    })

                buttonBox.append("text")
                    .text((d) => d)
                    .attr("x", (d, i) => i === 0 ? 4 : i === 1 ? 19 : 10)
                    .attr("y", 15)
                    .attr("cursor", "pointer")
                    .attr("class", "tree-button-text");

                // making the root for the data and treemap
                let root = d3.hierarchy(source).sum((d) => d.value);
                d3.treemap().size([w, h]).padding(0.8)(root);

                // making the color scale
                let categories = root.leaves().map((d) => d.data.category);
                categories = [...new Set(categories)];

                const colorsObject = {
                    "name": ["Baby Pink", "Pale Silver", "Morning Blue", "Light Slate Gray", "Lavendar Floral", "Canary", "CG Red", "Electric Blue", "Alice Blue", "Umber", "Emerald", "Mountbatten Pink", "Wild Blue Yonder", "Light Blue", "Tea Green", "Light Green", "Maximum Yellow", "Lemon Meringue", "Arylide Yellow"],
                    "hex": ["#EBBAB9", "#C9C5BA", "#97B1A6", "#698996", "#AB87FF", "#F5F500", "#DB3A34", "#64E9EE", "#DBE4EE", "#705D56", "#6FD08C", "#9E768F", "#9FA4C4", "#B3CDD1", "#C7F0BD", "#7CEA9C", "#FFC145", "#F4E8C1", "#E5D352"]
                };

                const colorHexes = colorsObject.hex.map((d) => d);
                const colorScale = d3.scaleOrdinal()
                    .domain(categories)
                    .range(colorHexes);

                // making the tree's rects
                const leaf = svgTree.selectAll("g")
                    .data(root.leaves())
                    .join("g")
                    .attr("transform", (d) => "translate(" + d.x0 + ", " + d.y0 + ")");

                leaf.append("rect")
                    .attr("data-name", (d) => d.data.name)
                    .attr("data-category", (d) => d.data.category)
                    .attr("data-value", (d) => d.data.value)
                    .attr("fill", (d) => colorScale(d.data.category))
                    .attr("width", (d) => d.x1 - d.x0)
                    .attr("height", (d) => d.y1 - d.y0)
                    .attr("class", "tile")
                    .on("mouseover", (d, i) => {
                        let name = d.data.name;
                        let category = d.data.category;
                        let value = parseFloat(d.data.value, 10);
                        let format = d3.format(",");

                        tooltip.transition()
                            .duration(250)
                            .style("opacity", 0.8)
                            .attr("data-value", d.data.value);
                        type === "Video Games" ?
                            tooltip.html("Name: " + name + "<br/>" + "Platform: " + category + "<br/>" + "Sales: " + format(value) + " million units")
                            : type === "Movies" ?
                                tooltip.html("Name: " + name + "<br/>" + "Genre: " + category + "<br/>" + "Domestic Box Office: $" + format(value))
                                :
                                tooltip.html("Name: " + name + "<br/>" + "Category: " + category + "<br/>" + "Amount Raised: $" + format(value))
                    })
                    .on("mousemove", () => {
                        d3.select("#tooltip")
                            .style("left", (d3.event.pageX + 10) + "px")
                            .style("top", (d3.event.pageY + 10) + "px");
                    })
                    .on("mouseout", () => {
                        d3.select("#tooltip")
                            .style("opacity", 0);
                    });

                leaf.append("text")
                    .selectAll("tspan")
                    .data((d) => (d.data.name).split(" ").slice(0, 4))
                    .join("tspan")
                    .text((d) => d.slice(0, 11))
                    .attr("x", 2)
                    .attr("y", (d, i) => {
                        return i + 0.7 + "em"
                    })
                    .style("font-size", "10px");

                // making the legend

                // dimensions of legend
                const wLegend = 500;
                const hLegend = 200;
                const padding = ({ "top": 20, "right": 30, "bottom": 20, "left": 30 });

                // svg for legend
                const svgLegend = d3.select("#data")
                    .append("svg")
                    .attr("id", "legend")
                    .attr("height", hLegend + padding.top + padding.bottom)
                    .attr("width", wLegend + padding.left + padding.right)
                    .attr("class", "treeLegend")
                    .selectAll("g")
                    .data(categories)
                    .join("g");

                svgLegend.attr("transform", (d, i) => "translate(" + Math.floor(i / 6) * 200 + ", " + (i % 6) * 30 + ")")
                    .append("rect")
                    .attr("class", "legend-item")
                    .attr("width", 20)
                    .attr("height", 20)
                    .attr("fill", (d) => colorScale(d));

                svgLegend.append("text")
                    .text((d) => d)
                    .attr("x", 25)
                    .attr("y", 15);

                svgTree.selectAll("div.parent").remove("*");
            }


        }).catch(function (error) {
            if (error) {
                console.warn(error);
            }
        });

        function removeElements() {
            // removes the previous selection's data so we're not continously appending when calling the treemap function
            d3.select("#data").selectAll("svg").remove();
            d3.select("#title").select("text").remove();
            d3.select("#title").select("svg").remove();
        }
    </script>
    <footer id="page-footer">
        <p id="footer-text">Find me at the links below!</p>
        <a href="https://github.com/Mir-Khan" target="_blank" id="github-link"><i class="fab fa-github fa-2x"></i></a>
        <a href="https://www.linkedin.com/in/mir-khan/" target="_blank" id="linkedin-link"><i
                class="fab fa-linkedin fa-2x"></i></a>
        <a href="/index.html" class="fourLink" id="home-link"><i class="fas fa-home fa-2x"></i></a>
    </footer>
</body>

</html>