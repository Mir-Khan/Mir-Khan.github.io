<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D3 Choropleth Map</title>
    <link href="../styles.css" rel="stylesheet">
    <script src="https://kit.fontawesome.com/63ada23c4f.js" crossorigin="anonymous"></script>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="https://d3js.org/d3-geo.v1.min.js"></script>
    <script src="https://d3js.org/d3-collection.v1.min.js"></script>
    <script src="https://d3js.org/d3-format.v1.min.js"></script>
    <script src="https://unpkg.com/topojson@3"></script>
</head>

<body class="choro-body">
    <div id="description" class="choro-description">
        <p>This choropleth map was made using data on bachelor degree owners aged 25 and over. The other dataset creates
            the actual map. The former can be found <a
                href="https://cdn.freecodecamp.org/testable-projects-fcc/data/choropleth_map/for_user_education.json">here</a>
            , while the latter can be found <a
                href="https://cdn.freecodecamp.org/testable-projects-fcc/data/choropleth_map/counties.json">here</a>.
            This was made as a part of
            the D3 challenges at <a href="https://www.freecodecamp.org/">Freecodecamp.org</a></p>
    </div>
    <div id="data" class="choro-container">
        <div id="title" class="choro-title"></div>
    </div>
    <script>
        // making the title
        d3.select("#title")
            .append("text")
            .html("<h1>" + "United States Educational Attainment" + "</h1>" + "<br/>" + "<p>" + "Percentage of adults age 25 and older with a bachelor's degree or higher (2010-2014)" + "</p>");
        // dimensions being used
        const w = 950;
        const h = 600;
        const padding = ({ "top": 20, "right": 20, "bottom": 20, "left": 20 });

        // data being used
        const EDU_URL = "https://cdn.freecodecamp.org/testable-projects-fcc/data/choropleth_map/for_user_education.json";
        const COUNTY_URL = "https://cdn.freecodecamp.org/testable-projects-fcc/data/choropleth_map/counties.json";

        // svg creation
        const svg = d3.select("#data")
            .append("svg")
            .attr("class", "choroClass")
            .attr("height", (h + padding.top + padding.bottom))
            .attr("width", (w + padding.left + padding.right));

        // tooltip creation
        let tooltip = d3.select("body")
            .append("div")
            .attr("class", "choro-tip")
            .attr("id", "tooltip")
            .style("opacity", 0);

        // getting the actual data with a promise
        Promise.all([d3.json(EDU_URL), d3.json(COUNTY_URL)]).then(function (files) {
            // files and data being used
            const education = files[0];
            const usaTopo = files[1];
            const rates = education.map((d) => d.bachelorsOrHigher);

            // scales being used
            const colScale = d3.scaleSequential()
                .interpolator(d3.interpolateOrRd)
                .domain([d3.min(rates), d3.max(rates)]);

            // path
            let path = d3.geoPath();

            // map creation
            // counties
            svg.append("g")
                .selectAll("path")
                .data(topojson.feature(usaTopo, usaTopo.objects.counties).features)
                .enter()
                .append("path")
                .attr("class", "county")
                .attr("data-fips", (d) => {
                    const result = education.filter((item) => item.fips === d.id);
                    return result[0] !== undefined ? result[0].fips : "Data was not found";
                })
                .attr("data-education", (d) => {
                    const result = education.filter((item) => item.fips === d.id);
                    return result[0] !== undefined ? result[0].bachelorsOrHigher : "Data was not found";
                })
                .attr("fill", (d) => {
                    const result = education.filter((item) => item.fips === d.id);
                    return result[0] !== undefined ? colScale(result[0].bachelorsOrHigher) : colScale(d3.min(rates));
                })
                .attr("d", path)
                .on("mouseover", (d, i) => {
                    let edu = (education.filter((item) => item.fips === d.id))[0].bachelorsOrHigher;
                    let place = (education.filter((item) => item.fips === d.id))[0].area_name + ", " + (education.filter((item) => item.fips === d.id))[0].state;
                    tooltip.transition()
                        .duration(250)
                        .style("opacity", 0.9)
                        .attr("data-education", edu);
                    tooltip.html(place + ": " + edu + "%");
                })
                .on("mousemove", () => {
                    d3.select("#tooltip")
                        .style("left", (d3.event.pageX + 10) + "px")
                        .style("top", (d3.event.pageY + 10) + "px");
                })
                .on("mouseout", () => {
                    d3.select("#tooltip")
                        .style("opacity", 0);
                });

            // state lines
            svg.append("path")
                .datum(topojson.mesh(usaTopo, usaTopo.objects.states), function (a, b) { return a !== b; })
                .attr("class", "states")
                .attr("fill", "none")
                .attr("stroke", "#000")
                .attr("d", path);

            // adding the legend here
            const legendDims = ({ "width": 200, "height": 10 });
            let maxRate = d3.max(rates) / 100;
            let minRate = d3.min(rates) / 100;

            const legendXScale = d3.scaleLinear()
                .domain([minRate, maxRate])
                .range([0, legendDims.width]);

            const legendColScale = d3.scaleSequential()
                .interpolator(d3.interpolateOrRd)
                .domain([minRate, maxRate]);

            // creation of legend ticks
            let vals = [];
            let numIncrements = 6;
            const legendTickWidth = legendDims.width / numIncrements;
            const increment = (maxRate - minRate) / numIncrements;
            for (let i = 0; i < numIncrements; i++) {
                let val = i * increment + minRate;
                vals.push(val);
            }

            // adding the axis itself and the g that holds the legend
            const legendXAxis = d3.axisBottom(legendXScale).tickFormat(d3.format(".0%"));
            const legend = svg.append("g")
                .attr("id", "legend")
                .attr("transform", "translate(" + 625 + "," + 30 + ")");

            legend.selectAll()
                .data(vals)
                .enter()
                .append("rect")
                .attr("x", (d) => legendXScale(d))
                .attr("y", 10)
                .attr("width", legendTickWidth)
                .attr("height", legendDims.height)
                .attr("fill", (d, i) => legendColScale(d));

            legend.append("g")
                .attr("id", "legend-x-axis")
                .attr("class", "choro-legend-x-axis")
                .attr("transform", "translate(0, " + 20 + ")")
                .call(legendXAxis);

        }).catch(function (error) {
            if (error) {
                console.warn(error);
            }
        })
    </script>
    <footer id="page-footer">
        <p id="footer-text">Find me at the links below!</p>
        <a href="https://github.com/Mir-Khan" target="_blank" id="github-link"><i class="fab fa-github fa-2x"></i></a>
        <a href="https://www.linkedin.com/in/mir-khan/" target="_blank" id="linkedin-link"><i
                class="fab fa-linkedin fa-2x"></i></a>
        <a href="/index.html" class="fourLink" id="home-link"><i class="fas fa-home fa-2x"></i></a>
    </footer>
</body>

</html>