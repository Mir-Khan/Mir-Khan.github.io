<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>D3 Bar Graph</title>
    <link href="../styles.css" rel="stylesheet">
    <script src="https://kit.fontawesome.com/63ada23c4f.js" crossorigin="anonymous"></script>
    <script src="https://d3js.org/d3.v5.min.js"></script>
</head>

<body class="bar-body">
    <div id="bar-description" class="bar-description">
        <p>This bar graph was made using the data found <a
                href="https://raw.githubusercontent.com/freeCodeCamp/ProjectReferenceData/master/GDP-data.json">here</a>
            as a part of the D3 challenges at <a href="https://www.freecodecamp.org/">Freecodecamp.org</a>
        </p>
    </div>
    <div id="bar-container" class="bar-container">
        <h1 id="title"></h1>
        <div id="data"></div>
    </div>
    <script>
        //title of chart
        let title = d3.select("#title")
            .text("GDP of US in Billions of Dollars 1947-2015")
            .attr("class", "barTitle");

        //dimensions of svg
        const w = 800;
        const h = 500;
        const barWidth = w / 275; //we have 275 items
        const padding = ({ "top": 20, "right": 10, "bottom": 30, "left": 20 });

        //creating the svg variable
        let svg = d3.select("#data").append("svg").attr("class", "barSvgClass").attr("width", w).attr("height", h);

        //tooltip div and data creation
        d3.select("body").append("div")
            .attr("class", "bar-tip")
            .attr("id", "tooltip")
            .style("opacity", 0);

        //regex for dates
        let qOne = /-01-/g;
        let qTwo = /-04-/g;
        let qThree = /-07-/g;
        let qFour = /-10-/g;

        //getting the JSON data

        //data source
        const url = 'https://raw.githubusercontent.com/freeCodeCamp/ProjectReferenceData/master/GDP-data.json';

        //requesting the data
        d3.json(url).then(function (data) {
            let dataset = data["data"];

            //making the arrays to hold the necessary data
            let gdp = dataset.map((item) => item[1]);
            let dates = dataset.map((item) => item[0]);

            //now making the scales based on the data
            //xScale is based on the dates, so it's a bit different

            /* since the Date() method takes into account your browser's 
            timezone, I opted to make sure the scale doesn't change based
            on that and is static */
            let utcDates = dates.map((item) => new Date(item));
            utcDates = utcDates.map((item) => new Date(item.setMinutes(item.getMinutes() + item.getTimezoneOffset())));
            let lastDate = d3.max(utcDates);
            let firstDate = d3.min(utcDates);

            const xScale = d3.scaleTime()
                .domain([firstDate, lastDate])
                .range([padding.left, w - padding.right]);
            // the y-scale can be normally made
            const yScale = d3.scaleLinear().domain([0, d3.max(gdp)])
                .range([h - padding.bottom, 0]);

            /* since the GDP becomes too large to show on any screen
            without scrolling, we have to scale it down enough */
            let gdpScale = d3.scaleLinear()
                .domain([0, d3.max(gdp)])
                .range([0, h - padding.bottom]);
            let miniGdp = gdp.map((item) => gdpScale(item));

            //formatting the financial quarter text
            function finQuarters(finDate) {
                return finDate.match(qOne) ? finDate.substring(0, 4) + ' Q1' :
                    finDate.match(qTwo) ? finDate.substring(0, 4) + ' Q2' :
                        finDate.match(qThree) ? finDate.substring(0, 4) + ' Q3' :
                            finDate.substring(0, 4) + ' Q4';
            }

            //formatting the money for the tooltip
            function formatMoney(money) {
                let original = money.toString();
                let returnVal = money >= 10000 ? [original.slice(0, 2), ",", original.slice(2)].join('') : [original.slice(0, 1), ",", original.slice(1)].join('');
                return returnVal;
            }

            //making the bar chart itself
            svg.selectAll("rect")
                .data(miniGdp).enter().append("rect")
                .attr("x", (d, i) => xScale(utcDates[i]))
                .attr("y", (d) => h - d - padding.bottom)
                .attr("width", barWidth)
                .attr("height", (d) => d)
                .attr("data-gdp", (d, i) => gdp[i])
                .attr("data-date", (d, i) => dates[i])
                .attr("class", "bar")
                .on("mouseover", (d, i) => {
                    let formatNumber = gdp[i] / Math.floor(gdp[i]) == 1 ? gdp[i] : gdp[i] < 10000 ? gdp[i].toPrecision(5) : gdp[i].toPrecision(6);
                    d3.select("#tooltip")
                        .transition()
                        .duration(150)
                        .style("opacity", 0.8)
                        .text(finQuarters(dates[i]) + " $" + formatMoney(formatNumber) + " billion")
                        .attr("data-date", dates[i]);
                })
                .on("mousemove", () => {
                    d3.select("#tooltip")
                        .style("left", (d3.event.pageX + 15) + "px")
                        .style("top", (d3.event.pageY + 10) + "px");
                })
                .on("mouseout", () => {
                    d3.select("#tooltip")
                        .style("opacity", 0);
                });

            //making the axes and formatting them
            const xAxis = d3.axisBottom(xScale);
            const yAxis = d3.axisLeft(yScale)
                .tickValues([1000, 2000, 3000, 4000, 5000, 6000, 7000, 8000, 9000, 10000, 11000, 12000, 13000, 14000, 15000, 16000, 17000, 18000]);

            svg.append("g")
                .attr("id", "x-axis")
                .attr("transform", "translate(0," + (h - padding.bottom) + ")")
                .call(xAxis);

            svg.append("g")
                .attr("id", "y-axis")
                .attr("transform", "translate(" + (padding.left) + ",0)")
                .call(yAxis.ticks(18).tickPadding(-44));

            svg.select("#y-axis")
                .selectAll("line")
                .attr("x2", 6);

            svg.select("#y-axis path"
            ).attr("d", "M-6,480.5H0.5V0.5H-0");

            svg.selectAll("#y-axis text")
                .attr("dy", "0.5em");

            svg.append("text")
                .attr("x", -400)
                .attr("y", 100)
                .text("Gross Domestic Product (Billions of USD)")
                .classed('rotation', true)
                .attr("transform", "rotate(-90)")
                .attr("class", "barYLabel");

            svg.select("#x-axis path").attr("d", "M20.5,6V0.5H792.5V0");
        })
            .catch(function (error) {
                if (error) {
                    console.warn(error);
                }
            });
    </script>
    <footer id="page-footer">
        <p id="footer-text">Find me at the links below!</p>
        <a href="https://github.com/Mir-Khan" target="_blank" id="github-link"><i class="fab fa-github fa-2x"></i></a>
        <a href="https://www.linkedin.com/in/mir-khan/" target="_blank" id="linkedin-link"><i
                class="fab fa-linkedin fa-2x"></i></a>
        <a href="/index.html" class="fourLink" id="home-link"><i class="fas fa-home fa-2x"></i></a>
    </footer>
</body>

</html>